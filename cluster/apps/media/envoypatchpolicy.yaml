---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: block-media-admin-access
  namespace: network
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: envoy-external
  type: JSONPatch
  jsonPatches:
    - type: "type.googleapis.com/envoy.config.route.v3.RouteConfiguration"
      name: network/envoy-external/https
      operation:
        op: add
        jsonPath: "..virtual_hosts[?match(@.name, '.*(son|rad)arr_${BASE_DOMAIN/./_}')]"
        path: "typed_per_filter_config/envoy.filters.http.rbac.admin"
        value:
          "@type": type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBACPerRoute
          rbac:
            rules:
              action: DENY
              policies:
                deny-admin-page:
                  permissions:
                    - header:
                        name: ":path"
                        safe_regex_match:
                          google_re2: {}
                          regex: "^/(settings|system).*"
                  principals:
                    - any: true
    - type: "type.googleapis.com/envoy.config.route.v3.RouteConfiguration"
      name: network/envoy-external/https
      operation:
        op: add
        jsonPath: "..virtual_hosts[?match(@.name, '.*sabnzbd_${BASE_DOMAIN/./_}')]"
        path: "typed_per_filter_config/envoy.filters.http.rbac.admin"
        value:
          "@type": type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBACPerRoute
          rbac:
            rules:
              action: DENY
              policies:
                deny-admin-page:
                  permissions:
                    - header:
                        name: ":path"
                        safe_regex_match:
                          google_re2: {}
                          regex: "^/config.*"
                  principals:
                    - any: true
