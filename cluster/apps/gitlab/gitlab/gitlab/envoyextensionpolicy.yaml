---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: external-access-controls
  namespace: gitlab
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: gitlab-webservice-external
  lua:
    - type: Inline
      inline: |
        function envoy_on_request(request_handle)
          local path = request_handle:headers():get(":path")

          if path == "/users/sign_in?auto_sign_in=false" then
            request_handle:respond(
              {
                [":status"] = "301",
                ["location"] = "https://git.${BASE_DOMAIN}"
              },
              "Direct login is blocked."
            )
            return
          end

          if string.match(path, "^/admin") then
            request_handle:respond(
              {
                [":status"] = "403",
              },
              "Admin page access is blocked."
            )
          end
        end
