---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: gitlab-backup-mirror
  namespace: gitlab
  labels:
    app.kubernetes.io/name: gitlab-backup-mirror
    app.kubernetes.io/component: job
spec:
  suspend: false
  schedule: 0 2 * * *
  timeZone: Europe/Zurich
  failedJobsHistoryLimit: 1
  successfulJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app.kubernetes.io/name: gitlab-backup-mirror
            app.kubernetes.io/component: job
        spec:
          containers:
            - name: gitlab-backup-mirror
              image: ghcr.io/containeroo/mirrio:3.1.1
              env:
                - name: TZ
                  value: Europe/Zurich
                - name: SOURCE_URL
                  value: http://gitlab-garage.gitlab.svc.cluster.local:3900
                - name: SOURCE_BUCKET
                  value: gitlab-backups
                - name: DESTINATION_URL
                  value: http://minio.minio.svc.cluster.local:9000
                - name: DESTINATION_BUCKET
                  value: gitlab-backups
                - name: JOB_NAME
                  value: gitlab-backup-mirror
                - name: RETENTION
                  value: 7d0h0m
                - name: PUSHGATEWAY_URL
                  value: http://prometheus-pushgateway.observability.svc.cluster.local:9091
              envFrom:
                - secretRef:
                    name: gitlab-backup-mirror
          restartPolicy: Never
          automountServiceAccountToken: false
