---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: smartctl-exporter
  namespace: observability
spec:
  groups:
    - name: smart-monitor
      rules:
        - alert: DeviceNotHealthy
          expr: (
            smartmon_device_smart_healthy
            * on(instance) group_left(nodename)
            node_uname_info
            ) != 1
          labels:
            severity: critical
          annotations:
            summary: Device «{{ $labels.device }}» is not healthy
            description: Device «{{ $labels.device }}» on node «{{ $labels.nodename }}» is not healthy (SMART health != 1).

        - alert: DeviceHasErrors
          expr: (
            smartmon_device_errors
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 0
          labels:
            severity: critical
          annotations:
            summary: Device «{{ $labels.device }}» has errors
            description: Device «{{ $labels.device }}» on node «{{ $labels.nodename }}» has {{ $value }} recorded errors.

    # HDD temperature (rotational=1)
    - name: disk-temperature-hdd
      rules:
        - alert: HostHddTooHot
          expr: (
            max_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[5m]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{rotational="1"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 60
          for: 5m
          labels:
            severity: critical
            disk_class: hdd
          annotations:
            summary: 'HDD «{{ $labels.device }}» too hot: {{ printf "%.1f" $value }} °C (5m max)'
            description: "HDD «{{ $labels.device }}» on node «{{ $labels.nodename }}» is too hot (5m max > 60 °C)."

        - alert: HostHddTempElevated
          expr: (
            avg_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[2h]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{rotational="1"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 50
          labels:
            severity: warning
            disk_class: hdd
          annotations:
            summary: 'HDD «{{ $labels.device }}» elevated temp {{ printf "%.1f" $value }} °C (2h avg)'
            description: "HDD «{{ $labels.device }}» on node «{{ $labels.nodename }}» has sustained elevated temperature (> 50 °C 2h avg)."

        - alert: HostHddWarmLong
          expr: (
            avg_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[12h]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{rotational="1"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 45
          labels:
            severity: info
            disk_class: hdd
          annotations:
            summary: 'HDD «{{ $labels.device }}» warm long-term: {{ printf "%.1f" $value }} °C (12h avg)'
            description: "HDD «{{ $labels.device }}» on node «{{ $labels.nodename }}» is warm over 12h (> 45 °C 12h avg). Consider airflow/placement."

    # SATA SSD temperature (rotational=0, non-NVMe)
    - name: disk-temperature-ssd
      rules:
        - alert: HostSsdTooHot
          expr: (
            max_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[5m]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{rotational="0", device!~"nvme.*"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 70
          for: 5m
          labels:
            severity: critical
            disk_class: ssd
          annotations:
            summary: 'SSD «{{ $labels.device }}» too hot: {{ printf "%.1f" $value }} °C (5m max)'
            description: "SSD «{{ $labels.device }}» on node «{{ $labels.nodename }}» is too hot (5m max > 70 °C)."

        - alert: HostSsdTempElevated
          expr: (
            avg_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[2h]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{rotational="0", device!~"nvme.*"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 60
          labels:
            severity: warning
            disk_class: ssd
          annotations:
            summary: 'SSD «{{ $labels.device }}» elevated temp {{ printf "%.1f" $value }} °C (2h avg)'
            description: "SSD «{{ $labels.device }}» on node «{{ $labels.nodename }}» has sustained high temperature (> 60 °C 2h avg)."

        - alert: HostSsdWarmLong
          expr: (
            avg_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[12h]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{rotational="0", device!~"nvme.*"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 50
          labels:
            severity: info
            disk_class: ssd
          annotations:
            summary: 'SSD «{{ $labels.device }}» warm long-term: {{ printf "%.1f" $value }} °C (12h avg)'
            description: "SSD «{{ $labels.device }}» on node «{{ $labels.nodename }}» is warm over 12h (> 50 °C 12h avg)."

    # NVMe temperature (device name nvme*)
    - name: disk-temperature-nvme
      rules:
        - alert: HostNvmeTooHot
          expr: (
            max_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[5m]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{device=~"nvme.*"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 80
          for: 5m
          labels:
            severity: critical
            disk_class: nvme
          annotations:
            summary: 'NVMe «{{ $labels.device }}» too hot: {{ printf "%.1f" $value }} °C (5m max)'
            description: "NVMe drive «{{ $labels.device }}» on node «{{ $labels.nodename }}» is too hot (5m max > 80 °C, likely throttling)."

        - alert: HostNvmeTempElevated
          expr: (
            avg_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[2h]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{device=~"nvme.*"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 70
          labels:
            severity: warning
            disk_class: nvme
          annotations:
            summary: 'NVMe «{{ $labels.device }}» elevated temp {{ printf "%.1f" $value }} °C (2h avg)'
            description: "NVMe drive «{{ $labels.device }}» on node «{{ $labels.nodename }}» has sustained high temperature (> 70 °C 2h avg)."

        - alert: HostNvmeWarmLong
          expr: (
            avg_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[12h]
            )
            * on(instance, device) group_left(rotational)
            node_disk_info{device=~"nvme.*"}
            * on(instance) group_left(nodename)
            node_uname_info
            ) > 55
          labels:
            severity: info
            disk_class: nvme
          annotations:
            summary: 'NVMe «{{ $labels.device }}» warm long-term: {{ printf "%.1f" $value }} °C (12h avg)'
            description: "NVMe drive «{{ $labels.device }}» on node «{{ $labels.nodename }}» is warm over 12h (> 55 °C 12h avg)."
