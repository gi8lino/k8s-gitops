---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: smartctl-exporter
  namespace: monitoring
spec:
  groups:
    - name: smart-monitor
      rules:
        - alert: DeviceNotHealthy
          expr: smartmon_device_smart_healthy  * on(instance) group_left(nodename) (node_uname_info) != 1
          annotations:
            description: Device «{{ $labels.device }}» on node «{{ $labels.nodename }}» is not healthy.
            summary: Device «{{ $labels.device }}» is not healthy.
          labels:
            severity: critical
        - alert: DeviceHasErrors
          expr: smartmon_device_errors * on(instance) group_left(nodename) (node_uname_info) > 0
          annotations:
            description: Device «{{ $labels.device }}» on node «{{ $labels.nodename }}» has {{ $value }} errors.
            summary: Device «{{ $labels.device }}» has errors.
          labels:
            severity: critical
    - name: disk-temperature
      rules:
        # Critical spike (bump to critical severity)
        - alert: HostDiskTooHot
          expr: max_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[5m]
            )
            * on(instance) group_left(nodename) node_uname_info
            > 60
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: 'Disk «{{ $labels.device }}» at {{ printf "%.1f" $value }} °C'
            description: "Disk «{{ $labels.device }}» on node «{{ $labels.nodename }}» is too hot."

        # Warning: persistently elevated
        - alert: HostDiskTempElevated
          expr: avg_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[2h]
            )
            * on(instance) group_left(nodename) node_uname_info
            > 47
          for: 0m
          labels:
            severity: warning
          annotations:
            summary: 'Disk «{{ $labels.device }}» elevated temp {{ printf "%.1f" $value }} °C (2h avg)'
            description: "Sustained elevated temperature may shorten disk lifespan on «{{ $labels.nodename }}»."

        # Info: simmering warm for a long time
        - alert: HostDiskTempWarmLong
          expr: avg_over_time(
            smartmon_attr_raw_value{name="temperature_celsius"}[12h]
            )
            * on(instance) group_left(nodename) node_uname_info
            > 42
          for: 0m
          labels:
            severity: info
          annotations:
            summary: 'Disk «{{ $labels.device }}» warm for long: {{ printf "%.1f" $value }} °C (12h avg)'
            description: "Consider airflow/placement on «{{ $labels.nodename }}». Long-term warmth raises failure risk."
