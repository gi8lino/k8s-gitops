apiVersion: v1
kind: ConfigMap
metadata:
  name: elastic-config
  namespace: cloudflare
data:
  elasticsearch.yaml: |
    discovery.type: single-node
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflare-fw-sync
  namespace: cloudflare
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
data:
  cloudflare: |
    #!/bin/bash
    set -o errexit
    set -o nounset

    [ -z "${ZONE_ID}" ] && echo "ZONE_ID is not set!" && exit 1
    [ -z "${GLOBAL_KEY}" ] && echo "GLOBAL_KEY is not set!" && exit 1
    [ -z "${EMAIL}" ] && echo "EMAIL is not set!" && exit 1

    INDEX_NAME=${INDEX_NAME:-cloudflare_fw_events}
    ELASTIC_FQDN=${ELASTIC_FQDN:-http://localhost:9200}
    ELASTIC_FQDN=${ELASTIC_FQDN%/}  # remove ending slash
    MINUTES=${MINUTES:-60}

    [ -n "${MINUTES##*[0-9]*}" ] && echo "MINUTES must be INT" && exit 1

    start_date=$(date -d "today -${MINUTES} minutes" +'%Y-%m-%dT%H:%M:%SZ')
    end_date=$(date +'%Y-%m-%dT%H:%M:%SZ')

    PAYLOAD='{ "query":
      "query {
        viewer {
          zones(filter: { zoneTag: $zoneTag }) {
          firewallEventsAdaptive(
            filter: $filter
            limit: 10000
            orderBy: [datetime_DESC, rayName_DESC]
          ) {
              action
              ruleId
              rayName
              clientAsn
              clientCountryName
              clientIP
              clientRequestPath
              clientRequestHTTPHost
              clientRequestQuery
              clientRefererHost
              clientRequestScheme
              edgeResponseStatus
              originResponseStatus
              datetime
              source
              userAgent
            }
          }
        }
      }",'

    PAYLOAD="$PAYLOAD
      \"variables\": {
        \"zoneTag\": \"$ZONE_ID\",
        \"filter\": {
          \"datetime_gt\": \"$start_date\",
          \"datetime_leq\": \"$end_date\"
        }
      }
    }"

    response=$(curl \
      --request POST \
      --header "Content-Type: application/json" \
      --header "X-Auth-Email: ${EMAIL}" \
      --header "X-Auth-key: ${GLOBAL_KEY}" \
      --data "$(echo $PAYLOAD)" \
      https://api.cloudflare.com/client/v4/graphql/)

    jq . <<< $response  # show response output

    response=$(curl \
      --silent \
      --show-error \
      --request POST \
      --header "Content-Type: application/x-ndjson" \
      --data-binary @<(jq -c '.data.viewer.zones[0].firewallEventsAdaptive[] | {"index":{"_id": .rayName}},  .' <<< ${response}) \
      ${ELASTIC_FQDN}/${INDEX_NAME}/_bulk)

    jq . <<< ${response}
