---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: falco
  namespace: falco-system
spec:
  interval: 5m
  chart:
    spec:
      chart: falco
      version: 2.0.6
      sourceRef:
        kind: HelmRepository
        name: falco-security
        namespace: flux-system
      interval: 5m
  dependsOn:
    - name: kube-prometheus-stack
      namespace: monitoring
  values:
    driver:
      enabled: true
      kind: ebpf
      ebpf:
        leastPrivileged: false
    collectors:
      containerd:
        socket: /var/run/k3s/containerd/containerd.sock
      docker:
        enabled: false
      crio:
        enabled: false
    falcosidekick:
      enabled: true
      replicaCount: 1
      config:
        alertmanager:
          hostport: http://kube-prometheus-stack-alertmanager.monitoring.svc.cluster.local:9093
          endpoint: /api/v2/alerts
          minimumpriority: emergency
      webui:
        enabled: true
        replicaCount: 1
        ingress:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: traefik
          hosts:
            - host: falco.local.${BASE_DOMAIN}
              paths:
                - path: /
                  pathType: Prefix
        redis:
          storageSize: 5Gi
    customRules:
      rules-admin-activities.yaml: |
        - rule: Detect su or sudo
          desc: detect sudo activities
          condition:
            spawned_process and proc.name in (sudo, su)
          output: >
            Detected sudo or su privilege escalation activity (user=%user.name command=%proc.cmdline)
          priority: WARNING
          tags: [process]
        - rule: Package Management Launched
          desc: detect package management launched
          condition: >
            spawned_process and user.name != "_apt" and package_mgmt_procs and not package_mgmt_ancestor_procs
          output: >
            Package management process launched in container (user=%user.name
            command=%proc.cmdline container_id=%container.id container_name=%container.name image=%container.image.repository:%container.image.tag)
          priority: ERROR
          tags: [process]
      rules-ssh-connections.yaml: |-
        - rule: Inbound SSH Connection
          desc: Detect Inbound SSH Connection
          condition: >
            ((evt.type in (accept,listen) and evt.dir=<) or
              (evt.type in (recvfrom,recvmsg))) and ssh_port
          output: >
            Inbound SSH connection (user=%user.name client_ip=%fd.cip client_port=%fd.cport server_ip=%fd.sip)
          priority: WARNING
          tags: [network]
        - rule: Outbound SSH Connection
          desc: Detect Outbound SSH Connection
          condition: >
            ((evt.type = connect and evt.dir=<) or
              (evt.type in (sendto,sendmsg))) and ssh_port
          output: >
            Outbound SSH connection (user=%user.name server_ip=%fd.sip server_port=%fd.sport client_ip=%fd.cip)
          priority: WARNING
          tags: [network]
        - rule: Redirect STDOUT/STDIN to Network Connection in Container
          desc: Detect redirecting stdout/stdin to network connection in container (potential reverse shell).
          condition: evt.type=dup and evt.dir=> and container and fd.num in (0, 1, 2) and fd.type in ("ipv4", "ipv6") and not user_known_stand_streams_redirect_activities
          output: >
            Redirect stdout/stdin to network connection (user=%user.name user_loginuid=%user.loginuid %container.info process=%proc.name parent=%proc.pname cmdline=%proc.cmdline terminal=%proc.tty container_id=%container.id image=%container.image.repository fd.name=%fd.name fd.num=%fd.num fd.type=%fd.type fd.sip=%fd.sip)
          priority: EMERGENCY
          tags: [network]
      rules-file-integrity.yaml: |-
        - rule: Kernel Module Modification
          desc: detect kernel module change
          condition: >
            spawned_process and proc.name in (insmod, modprobe)
          output: >
            Kernel Module Change (user=%user.name
            command=%proc.cmdline file=%fd.name parent=%proc.pname pcmdline=%proc.pcmdline gparent=%proc.aname[2] result=%evt.res)
          priority: WARNING
          tags: [process]
        - rule: Node Created in Filesystem
          desc: detect node created in filesystem
          condition: >
            spawned_process and proc.name = mknod
          output: >
            Node Creation in Filesystem (user=%user.name
            command=%proc.cmdline file=%fd.name parent=%proc.pname pcmdline=%proc.pcmdline gparent=%proc.aname[2] result=%evt.res)
          priority: WARNING
          tags: [filesystem]
        - rule: Listen on New Port
          desc: Detection a new port is listening
          condition:
            evt.type = listen
          output: >
            A new port is open to listen (port=%fd.sport ip=%fd.sip)
          priority: WARNING
          tags: [network]
